# Инструкция по развертыванию Телеграм-бота "Counter" на сервере

Это пошаговая инструкция по развертыванию вашего Телеграм-бота для учета финансов на сервере. Следуйте этим шагам, чтобы ваш бот работал стабильно и был доступен 24/7.

## Содержание

1. [Предварительные требования](#предварительные-требования)
2. [Подготовка бота Telegram](#подготовка-бота-telegram)
3. [Развертывание на сервере](#развертывание-на-сервере)
    - [Автоматический способ](#автоматический-способ)
    - [Ручной способ](#ручной-способ)
4. [Настройка переменных окружения](#настройка-переменных-окружения)
5. [Проверка работоспособности](#проверка-работоспособности)
6. [Обслуживание бота](#обслуживание-бота)
7. [Устранение проблем](#устранение-проблем)

## Предварительные требования

### На вашем компьютере

-   Git (для клонирования репозитория)
-   SSH-клиент (например, OpenSSH или PuTTY для Windows)

### На сервере

-   Операционная система Linux (Ubuntu, Debian и т.д.)
-   Docker и Docker Compose
-   Доступ по SSH с правами root или sudo

## Подготовка бота Telegram

1. **Создайте нового бота** через [@BotFather](https://t.me/BotFather) в Telegram:

    - Напишите `/start`, затем `/newbot`
    - Укажите имя для бота (например, "Мой финансовый помощник")
    - Укажите уникальное имя пользователя, оканчивающееся на "bot" (например, "my_finance_helper_bot")
    - BotFather выдаст вам токен вида `123456789:ABCDefGhIJKlmNoPQRsTUVwxyZ`
    - **Сохраните этот токен**, он понадобится при настройке

2. **Узнайте свой Telegram ID** с помощью [@userinfobot](https://t.me/userinfobot):
    - Просто напишите этому боту любое сообщение
    - Он ответит вам информацией, включая ваш ID (например, `123456789`)
    - Этот ID будет нужен для настройки администраторов бота

## Развертывание на сервере

У вас есть два способа развернуть бота на сервере: автоматический (с помощью скрипта) и ручной.

### Автоматический способ

1. **Клонируйте репозиторий** (если вы еще этого не сделали):

    ```bash
    git clone https://github.com/ваш-аккаунт/counter.git
    cd counter
    ```

2. **Запустите скрипт развертывания**:

    Для Linux/Mac:

    ```bash
    chmod +x scripts/deploy.sh  # Делаем скрипт исполняемым, если нужно
    ./scripts/deploy.sh пользователь IP-адрес-сервера
    ```

    Для Windows:

    ```cmd
    scripts\deploy.bat пользователь IP-адрес-сервера
    ```

    Замените `пользователь` и `IP-адрес-сервера` на ваши данные для доступа к серверу.

3. **Настройте .env файл** на сервере после автоматического развертывания:
    ```bash
    ssh пользователь@IP-адрес-сервера
    cd /opt/finance_bot
    nano .env
    ```

### Ручной способ

1. **Клонируйте репозиторий** (если вы еще этого не сделали):

    ```bash
    git clone https://github.com/ваш-аккаунт/counter.git
    cd counter
    ```

2. **Создайте архив проекта**:

    ```bash
    git archive --format=tar.gz -o deploy.tar.gz HEAD
    ```

3. **Скопируйте архив на сервер**:

    ```bash
    scp deploy.tar.gz пользователь@IP-адрес-сервера:/tmp/
    ```

4. **Подключитесь к серверу** и выполните следующие команды:

    ```bash
    ssh пользователь@IP-адрес-сервера

    # Создайте директорию для проекта
    sudo mkdir -p /opt/finance_bot
    cd /opt/finance_bot

    # Создайте необходимые директории
    sudo mkdir -p data logs backup
    sudo chmod 755 data logs backup

    # Распакуйте архив
    sudo tar -xzf /tmp/deploy.tar.gz -C /opt/finance_bot

    # Создайте .env файл из примера
    sudo cp .env.example .env

    # Настройте .env файл с вашими параметрами
    sudo nano .env

    # Запустите контейнеры
    sudo docker-compose up -d --build

    # Проверьте права доступа
    sudo chown -R 1000:1000 data logs backup
    ```

## Настройка переменных окружения

Файл `.env` содержит критически важные настройки. Вам нужно отредактировать этот файл:

```bash
# Подключитесь к серверу (если вы ещё не подключены)
ssh пользователь@IP-адрес-сервера
cd /opt/finance_bot
nano .env
```

Настройте следующие параметры:

```
# Вставьте токен, полученный от @BotFather
TELEGRAM_BOT_TOKEN=12345678:ABCDefGhIJKlmNoPQRsTUVwxyZ

# Оставьте эти настройки как есть
DB_TYPE=sqlite
DB_PATH=data/finance.db

# Вставьте свой Telegram ID, полученный от @userinfobot
# Если нужно указать несколько администраторов, разделите их запятыми
ADMIN_USER_IDS=123456789,987654321
```

Сохраните файл (в nano: Ctrl+O, затем Enter, потом Ctrl+X).

## Проверка работоспособности

После настройки проверьте, что бот работает:

1. **Проверьте логи**:

    ```bash
    sudo docker-compose logs -f bot
    ```

    Вы должны увидеть сообщения о запуске, без ошибок.

2. **Проверьте директории**:

    ```bash
    ls -la data/ logs/ backup/
    ```

    Должны быть созданы необходимые файлы.

3. **Проверьте бота в Telegram**:
    - Откройте Telegram
    - Найдите своего бота по имени пользователя
    - Напишите команду `/start`
    - Бот должен ответить приветственным сообщением

## Обслуживание бота

### Обновление бота

Если вы внесли изменения в код и хотите обновить бота:

```bash
# Подключитесь к серверу
ssh пользователь@IP-адрес-сервера
cd /opt/finance_bot

# Получите последнюю версию (если вы используете git на сервере)
sudo git pull

# ИЛИ загрузите обновленный архив, как описано выше
# И распакуйте его

# Перезапустите контейнеры
sudo docker-compose down
sudo docker-compose up -d --build
```

### Резервное копирование

Для создания резервной копии базы данных:

```bash
# Подключитесь к серверу
ssh пользователь@IP-адрес-сервера
cd /opt/finance_bot

# Остановите бота
sudo docker-compose down

# Создайте резервную копию
sudo cp data/finance.db backup/finance_$(date +%Y%m%d_%H%M%S).db

# Запустите бота
sudo docker-compose up -d
```

### Восстановление из резервной копии

```bash
# Подключитесь к серверу
ssh пользователь@IP-адрес-сервера
cd /opt/finance_bot

# Остановите бота
sudo docker-compose down

# Сделайте копию текущей базы данных
sudo cp data/finance.db data/finance.db.bak

# Восстановите из резервной копии (укажите правильное имя файла)
sudo cp backup/finance_YYYYMMDD_HHMMSS.db data/finance.db

# Запустите бота
sudo docker-compose up -d
```

### Просмотр логов

```bash
# Подключитесь к серверу
ssh пользователь@IP-адрес-сервера
cd /opt/finance_bot

# Просмотр логов в реальном времени
sudo docker-compose logs -f

# Просмотр только последних 100 строк
sudo docker-compose logs --tail 100
```

## Устранение проблем

### Проблема: Бот не отвечает на сообщения

1. **Проверьте логи**:

    ```bash
    sudo docker-compose logs -f bot
    ```

    Ищите ошибки в логах.

2. **Проверьте запущен ли контейнер**:

    ```bash
    sudo docker-compose ps
    ```

    Статус должен быть "Up".

3. **Перезапустите контейнер**:
    ```bash
    sudo docker-compose restart bot
    ```

### Проблема: Ошибки с базой данных

1. **Проверьте права доступа**:

    ```bash
    sudo chmod 755 data
    sudo chown -R 1000:1000 data
    ```

2. **Проверьте файл базы данных**:
    ```bash
    ls -la data/finance.db
    ```
    Если файл поврежден или отсутствует:
    ```bash
    sudo docker-compose down
    sudo rm data/finance.db  # Удалите поврежденный файл
    sudo docker-compose up -d  # База будет создана заново
    ```

### Проблема: Недостаточно места на диске

1. **Проверьте свободное место**:

    ```bash
    df -h
    ```

2. **Очистите неиспользуемые Docker образы**:
    ```bash
    sudo docker system prune -a
    ```

### Проблема: Ошибки с Docker

1. **Перезапустите Docker**:

    ```bash
    sudo systemctl restart docker
    sudo docker-compose down
    sudo docker-compose up -d
    ```

2. **Проверьте статус Docker**:
    ```bash
    sudo systemctl status docker
    ```

---

Если у вас возникли проблемы, которые не описаны в этой инструкции, обратитесь к документации Docker или к специалисту по системному администрированию.
